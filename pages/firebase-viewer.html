<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üî• Firebase Data Viewer - English Fun</title>
  
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  
  <style>
    html, body {
      height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      overflow-x: hidden;
    }
    
    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      padding: 15px 0;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    
    .header .container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      font-size: 1.8em;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .nav-menu {
      display: flex;
      gap: 20px;
      list-style: none;
      margin: 0;
      padding: 0;
    }
    
    .nav-menu a {
      text-decoration: none;
      color: #495057;
      font-weight: 500;
      padding: 8px 16px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .nav-menu a:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .main-container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 0 20px;
    }
    
    .viewer-card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }
    
    .user-info-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
    }
    
    .user-id-box {
      font-family: monospace;
      background: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      word-break: break-all;
      font-size: 0.9em;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .stat-box {
      background: rgba(255,255,255,0.2);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
    
    .stat-box .value {
      font-size: 2.5em;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .stat-box .label {
      font-size: 0.9em;
      opacity: 0.9;
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 25px;
    }
    
    .btn-action {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      color: white;
    }
    
    .btn-action:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .btn-export { background: #4CAF50; }
    .btn-console { background: #FF9800; }
    .btn-refresh { background: #2196F3; }
    .btn-clear { background: #f44336; }
    
    .lesson-section {
      border: 2px solid #e0e0e0;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .lesson-title {
      font-size: 1.3em;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 15px;
    }
    
    .items-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 12px;
    }
    
    .item-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      border-left: 4px solid #ccc;
      transition: all 0.3s ease;
    }
    
    .item-card:hover {
      transform: translateX(5px);
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    
    .item-card.mastered { border-left-color: #4CAF50; }
    .item-card.learning { border-left-color: #FF9800; }
    .item-card.weak { border-left-color: #f44336; }
    
    .item-text {
      font-weight: bold;
      font-size: 1.1em;
      margin-bottom: 8px;
      color: #2d3748;
    }
    
    .item-stats {
      font-size: 0.9em;
      color: #666;
      margin-bottom: 5px;
    }
    
    .item-meta {
      font-size: 0.8em;
      color: #999;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #e0e0e0;
    }
    
    .loading {
      text-align: center;
      padding: 80px 20px;
      color: white;
    }
    
    .spinner {
      display: inline-block;
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: #999;
    }
    
    .empty-state .icon {
      font-size: 5em;
      margin-bottom: 20px;
    }
    
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .items-grid {
        grid-template-columns: 1fr;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .btn-action {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="container">
      <div class="logo">üî• Firebase Data Viewer</div>
      <ul class="nav-menu">
        <li><a href="../index.html">üè† Trang ch·ªß</a></li>
        <li><a href="dashboard.html">üìä Dashboard</a></li>
      </ul>
    </div>
  </div>
  
  <!-- Main Container -->
  <div class="main-container">
    <div id="viewer-content" class="loading">
      <div class="spinner"></div>
      <p style="margin-top: 20px; font-size: 1.2em;">ƒêang t·∫£i d·ªØ li·ªáu Firebase...</p>
    </div>
  </div>
  
  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  
  <!-- Firebase Config & Progress Manager -->
  <script src="../js/firebase-config.js"></script>
  <script src="../js/quiz-progress.js"></script>
  
  <script>
    let LESSONS_DATA = null;
    
    // ===== INIT =====
    window.addEventListener('load', async () => {
      await initApp();
    });
    
    async function initApp() {
      try {
        // Init Firebase
        await ProgressManager.init();
        
        // Load lessons data
        const response = await fetch('../data/lessons.json');
        LESSONS_DATA = await response.json();
        
        // Load and render
        await ProgressManager.load();
        renderViewer();
        
      } catch (error) {
        console.error('Error initializing app:', error);
        showError('C√≥ l·ªói khi t·∫£i d·ªØ li·ªáu. Vui l√≤ng refresh trang!');
      }
    }
    
    // ===== RENDER VIEWER =====
    function renderViewer() {
      const container = document.getElementById('viewer-content');
      
      if (!ProgressManager.userId) {
        showError('‚ö†Ô∏è Firebase ch∆∞a k·∫øt n·ªëi. Vui l√≤ng ƒë·ª£i ho·∫∑c refresh trang.');
        return;
      }
      
      const stats = ProgressManager.getStats();
      const progress = ProgressManager.data.progress || [];
      
      let html = `
        <!-- User Info Card -->
        <div class="user-info-card">
          <h2 style="margin: 0 0 10px 0;">üë§ Th√¥ng tin User</h2>
          
          <div class="user-id-box">
            <strong>User ID:</strong><br>
            ${ProgressManager.userId}
            <button onclick="copyUserId()" style="margin-top: 10px; padding: 8px 16px; background: white; color: #667eea; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
              üìã Copy User ID
            </button>
          </div>
          
          <div class="stats-grid">
            <div class="stat-box">
              <div class="value">${stats.total}</div>
              <div class="label">T·ªïng Items</div>
            </div>
            <div class="stat-box" style="background: rgba(76, 175, 80, 0.3);">
              <div class="value">${stats.mastered}</div>
              <div class="label">Th√†nh th·∫°o</div>
            </div>
            <div class="stat-box" style="background: rgba(255, 152, 0, 0.3);">
              <div class="value">${stats.learning}</div>
              <div class="label">ƒêang h·ªçc</div>
            </div>
            <div class="stat-box" style="background: rgba(158, 158, 158, 0.3);">
              <div class="value">${stats.newItems}</div>
              <div class="label">Ch∆∞a h·ªçc</div>
            </div>
          </div>
        </div>
        
        <!-- Main Viewer Card -->
        <div class="viewer-card">
          <!-- Action Buttons -->
          <div class="action-buttons">
            <button class="btn-action btn-export" onclick="exportData()">
              üíæ Export JSON
            </button>
            <button class="btn-action btn-console" onclick="openFirebaseConsole()">
              üîó Firebase Console
            </button>
            <button class="btn-action btn-refresh" onclick="refreshData()">
              üîÑ Refresh Data
            </button>
            <button class="btn-action btn-clear" onclick="confirmClearData()">
              üóëÔ∏è Clear All Data
            </button>
          </div>
          
          <h3 style="margin-bottom: 20px;">üìã Progress Data theo B√†i h·ªçc</h3>
      `;
      
      // Group by lesson
      const byLesson = {};
      progress.forEach(item => {
        const lessonId = item.lessonId || 0;
        if (!byLesson[lessonId]) byLesson[lessonId] = [];
        byLesson[lessonId].push(item);
      });
      
      // Render each lesson
      const sortedLessons = Object.keys(byLesson).sort((a, b) => parseInt(a) - parseInt(b));
      
      if (sortedLessons.length === 0) {
        html += `
          <div class="empty-state">
            <div class="icon">üìù</div>
            <h3>Ch∆∞a c√≥ d·ªØ li·ªáu h·ªçc t·∫≠p</h3>
            <p>H√£y l√†m v√†i b√†i quiz ƒë·ªÉ b·∫Øt ƒë·∫ßu ghi nh·∫≠n ti·∫øn ƒë·ªô!</p>
            <a href="../index.html" style="display: inline-block; margin-top: 20px; padding: 12px 24px; background: #667eea; color: white; text-decoration: none; border-radius: 10px; font-weight: bold;">
              üöÄ B·∫Øt ƒë·∫ßu h·ªçc
            </a>
          </div>
        `;
      } else {
        for (const lessonId of sortedLessons) {
          const items = byLesson[lessonId];
          const lesson = LESSONS_DATA?.lessons?.find(l => l.id === parseInt(lessonId));
          const lessonName = lesson ? `B√†i ${lesson.id}: ${lesson.title}` : `B√†i ${lessonId}`;
          
          html += `
            <div class="lesson-section">
              <div class="lesson-title">
                üìö ${lessonName}
                <span style="font-size: 0.8em; color: #999; font-weight: normal;">(${items.length} items)</span>
              </div>
              <div class="items-grid">
          `;
          
          items.forEach(item => {
            const text = item.word || (item.sentence?.en || 'Unknown');
            const meaning = item.word ? 
              (lesson?.words.find(w => w.word === item.word)?.meaning || '') : 
              (item.sentence?.vi || '');
            
            const correct = item.correct || 0;
            const wrong = item.wrong || 0;
            const total = correct + wrong;
            const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
            
            let status = 'weak';
            if (accuracy >= 80 && total >= 5 && wrong === 0) {
              status = 'mastered';
            } else if (total > 0) {
              status = 'learning';
            }
            
            const statusLabel = status === 'mastered' ? '‚úÖ Th√†nh th·∫°o' :
                              status === 'learning' ? 'üìù ƒêang h·ªçc' :
                              'üÜï M·ªõi';
            
            html += `
              <div class="item-card ${status}">
                <div class="item-text">${text}</div>
                ${meaning ? `<div style="font-size: 0.9em; color: #666; margin-bottom: 8px;">${meaning}</div>` : ''}
                <div class="item-stats">
                  ‚úÖ ${correct} ƒë√∫ng | ‚ùå ${wrong} sai | üìä ${accuracy}% | ${statusLabel}
                </div>
                ${item.interval ? `
                  <div style="font-size: 0.85em; color: #999; margin-top: 5px;">
                    üîÑ SR: interval ${item.interval} days, ease ${item.easeFactor?.toFixed(2)}, reps ${item.repetitions}
                  </div>
                ` : ''}
                <div class="item-meta">
                  ${item.lastReviewed ? `üìÖ H·ªçc l·∫ßn cu·ªëi: ${new Date(item.lastReviewed).toLocaleString('vi-VN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                  })}` : 'üìÖ Ch∆∞a h·ªçc'}
                </div>
              </div>
            `;
          });
          
          html += `
              </div>
            </div>
          `;
        }
      }
      
      html += `</div>`; // Close viewer-card
      
      container.innerHTML = html;
    }
    
    // ===== ACTIONS =====
    function copyUserId() {
      const userId = ProgressManager.userId;
      navigator.clipboard.writeText(userId).then(() => {
        alert('‚úÖ ƒê√£ copy User ID!\n\n' + userId + '\n\nL∆∞u ID n√†y ƒë·ªÉ backup d·ªØ li·ªáu c·ªßa b·∫°n.');
      }).catch(err => {
        console.error('Copy failed:', err);
        prompt('Copy User ID n√†y:', userId);
      });
    }
    
    function exportData() {
      const data = ProgressManager.data;
      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `firebase_backup_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      alert('‚úÖ ƒê√£ export backup file!\n\nFile ch·ª©a to√†n b·ªô progress data t·ª´ Firebase.');
    }
    
    function openFirebaseConsole() {
      window.open('https://console.firebase.google.com/project/english-fun-1937c/database/english-fun-1937c-default-rtdb/data', '_blank');
    }
    
    async function refreshData() {
      const container = document.getElementById('viewer-content');
      container.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p style="margin-top: 20px; font-size: 1.2em;">ƒêang t·∫£i l·∫°i d·ªØ li·ªáu...</p>
        </div>
      `;
      
      await ProgressManager.load();
      
      setTimeout(() => {
        renderViewer();
      }, 500);
    }
    
    function confirmClearData() {
      const confirmed = confirm(
        '‚ö†Ô∏è C·∫¢NH B√ÅO!\n\n' +
        'B·∫°n c√≥ ch·∫Øc mu·ªën X√ìA T·∫§T C·∫¢ d·ªØ li·ªáu h·ªçc t·∫≠p?\n\n' +
        'H√†nh ƒë·ªông n√†y KH√îNG TH·ªÇ HO√ÄN T√ÅC!\n\n' +
        'Nh·∫•n OK ƒë·ªÉ x√°c nh·∫≠n x√≥a, ho·∫∑c Cancel ƒë·ªÉ h·ªßy.'
      );
      
      if (confirmed) {
        const doubleConfirm = prompt(
          'Nh·∫≠p "XOA" (vi·∫øt hoa) ƒë·ªÉ x√°c nh·∫≠n x√≥a t·∫•t c·∫£ d·ªØ li·ªáu:'
        );
        
        if (doubleConfirm === 'XOA') {
          clearAllData();
        } else {
          alert('‚ùå ƒê√£ h·ªßy. D·ªØ li·ªáu ƒë∆∞·ª£c gi·ªØ nguy√™n.');
        }
      }
    }
    
    async function clearAllData() {
      try {
        // Clear Firebase
        if (ProgressManager.userId) {
          await firebaseDB.ref(`users/${ProgressManager.userId}/progress`).remove();
          console.log('üóëÔ∏è Cleared Firebase data');
        }
        
        // Clear ProgressManager
        ProgressManager.data = { progress: [] };
        
        // Clear localStorage
        localStorage.removeItem('english_learning_progress');
        
        alert('‚úÖ ƒê√£ x√≥a t·∫•t c·∫£ d·ªØ li·ªáu!\n\nTrang s·∫Ω ƒë∆∞·ª£c reload.');
        location.reload();
        
      } catch (error) {
        console.error('Error clearing data:', error);
        alert('‚ùå C√≥ l·ªói khi x√≥a d·ªØ li·ªáu: ' + error.message);
      }
    }
    
    function showError(message) {
      const container = document.getElementById('viewer-content');
      container.innerHTML = `
        <div class="viewer-card">
          <div style="text-align: center; padding: 50px; color: #f44336;">
            <div style="font-size: 4em; margin-bottom: 20px;">‚ö†Ô∏è</div>
            <h3>${message}</h3>
            <button onclick="location.reload()" style="margin-top: 20px; padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold;">
              üîÑ Refresh Trang
            </button>
          </div>
        </div>
      `;
    }
  </script>
</body>
</html>

