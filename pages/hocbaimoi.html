<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üéâ H·ªçc T·ª´ M·ªõi - English Fun</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    /* üé® Giao di·ªán vui nh·ªôn cho l·ªõp 1 */
    html,
    body {
      height: 100%;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: 'Comic Sans MS', 'Arial Rounded MT Bold', sans-serif;
      overflow-x: hidden;
    }

    .container-main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 10px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Header vui nh·ªôn */
    .fun-header {
      background: linear-gradient(135deg, #FFD93D 0%, #FFA500 100%);
      border-radius: 20px;
      padding: 12px 20px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
      margin-bottom: 10px;
      animation: bounceIn 0.8s ease-out;
      flex-shrink: 0;
    }

    .fun-header h1 {
      margin: 0;
      font-size: 1.6em;
      color: #fff;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
    }

    .fun-header .lesson-title {
      font-size: 1em;
      color: #fff;
      margin-top: 5px;
      opacity: 0.95;
      text-align: center;
    }

    /* Progress bar si√™u ƒë·∫πp */
    .progress-container {
      background: white;
      border-radius: 15px;
      padding: 10px 15px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
      margin-bottom: 10px;
      animation: slideDown 0.6s ease-out;
      flex-shrink: 0;
    }

    .progress-text {
      font-size: 1em;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 8px;
      text-align: center;
    }

    .progress-bar-custom {
      height: 30px;
      background: linear-gradient(90deg, #e0e0e0 0%, #f0f0f0 100%);
      border-radius: 20px;
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%);
      border-radius: 20px;
      transition: width 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 0.95em;
      box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4);
    }

    /* Learning card - Card h·ªçc si√™u ƒë·∫πp */
    .learning-card {
      background: white;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      gap: 15px;
      animation: zoomIn 0.5s ease-out;
      position: relative;
      overflow-y: auto;
      overflow-x: hidden;
      min-height: 0;
      scrollbar-width: thin;
      scrollbar-color: rgba(102, 126, 234, 0.3) transparent;
    }

    .learning-card::-webkit-scrollbar {
      width: 6px;
    }

    .learning-card::-webkit-scrollbar-track {
      background: transparent;
    }

    .learning-card::-webkit-scrollbar-thumb {
      background: rgba(102, 126, 234, 0.3);
      border-radius: 3px;
    }

    .learning-card::-webkit-scrollbar-thumb:hover {
      background: rgba(102, 126, 234, 0.5);
    }

    .learning-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
      animation: rotate 20s linear infinite;
      pointer-events: none;
      z-index: 0;
    }

    .step-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
      color: white;
      padding: 6px 15px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: bold;
      box-shadow: 0 3px 8px rgba(255, 107, 107, 0.4);
      animation: pulse 2s ease-in-out infinite;
      z-index: 10;
    }

    .step-title {
      font-size: 1.5em;
      color: #667eea;
      margin-bottom: 10px;
      text-align: center;
      font-weight: bold;
      animation: fadeIn 0.8s ease-out;
      position: relative;
      z-index: 5;
      line-height: 1.2;
    }

    .step-instruction {
      font-size: 1.1em;
      color: #666;
      margin-bottom: 10px;
      text-align: center;
      animation: fadeIn 1s ease-out;
      position: relative;
      z-index: 5;
    }

    /* Image container */
    .image-container {
      width: 100%;
      max-width: 350px;
      height: 180px;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 15px;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      overflow: hidden;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
      animation: fadeIn 0.8s ease-out;
      position: relative;
      z-index: 5;
      flex-shrink: 1;
    }

    .image-container img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      animation: zoomIn 0.6s ease-out;
    }

    .image-placeholder {
      font-size: 4em;
      animation: bounce 2s ease-in-out infinite;
    }

    /* Text display */
    .text-display {
      font-size: 2.2em;
      font-weight: bold;
      margin: 8px 0;
      text-align: center;
      animation: fadeIn 0.8s ease-out;
      position: relative;
      z-index: 5;
      line-height: 1.3;
    }

    #text-container {
      position: relative;
      z-index: 5;
      flex-shrink: 0;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .text-english {
      color: #667eea;
      text-shadow: 2px 2px 4px rgba(102, 126, 234, 0.3);
    }

    .text-vietnamese {
      color: #FF6B6B;
      font-size: 1.6em;
      margin-top: 5px;
    }

    /* Flashcard styles */
    .flashcard {
      width: 100%;
      max-width: 400px;
      min-height: 250px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px;
      padding: 30px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease;
      position: relative;
      z-index: 5;
    }

    .flashcard:hover {
      transform: scale(1.05);
    }

    .flashcard.flipped {
      background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
    }

    .flashcard-content {
      color: white;
      font-size: 2em;
      font-weight: bold;
      text-align: center;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .flashcard-hint {
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.9em;
      margin-top: 15px;
      animation: pulse 2s ease-in-out infinite;
    }

    /* Fill blank styles */
    .word-display {
      font-size: 2.5em;
      margin: 10px 0;
      letter-spacing: 8px;
      position: relative;
      z-index: 5;
      flex-shrink: 0;
    }

    .letter-fixed {
      display: inline-block;
      padding: 5px 10px;
      color: #667eea;
      font-weight: bold;
    }

    .letter-blank {
      display: inline-block;
      width: 50px;
      height: 60px;
      border: 3px dashed #FF6B6B;
      border-radius: 10px;
      background: #fff;
      margin: 0 5px;
      text-align: center;
      line-height: 60px;
      font-size: 1em;
      color: #4CAF50;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .letter-blank.filled {
      background: #C8E6C9;
      border-color: #4CAF50;
      border-style: solid;
    }

    .letter-blank.wrong {
      background: #FFCDD2;
      border-color: #f44336;
      animation: shake 0.5s;
    }

    .letter-choices {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-top: 15px;
      position: relative;
      z-index: 5;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    .letter-choice {
      width: 55px;
      height: 55px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 1.6em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      flex-shrink: 0;
    }

    .letter-choice:hover {
      transform: translateY(-5px) scale(1.1);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }

    .letter-choice.used {
      opacity: 0.3;
      pointer-events: none;
    }

    /* Typing input */
    .typing-input {
      width: 100%;
      max-width: 400px;
      padding: 15px 20px;
      font-size: 2em;
      font-weight: bold;
      text-align: center;
      border: 3px solid #667eea;
      border-radius: 15px;
      background: #fff;
      color: #667eea;
      font-family: 'Comic Sans MS', 'Arial Rounded MT Bold', sans-serif;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
      letter-spacing: 3px;
    }

    .typing-input:focus {
      outline: none;
      border-color: #4CAF50;
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
      transform: scale(1.02);
    }

    .typing-input.correct {
      border-color: #4CAF50;
      background: #E8F5E9;
      animation: successPulse 0.5s ease;
    }

    .typing-input.wrong {
      border-color: #f44336;
      background: #FFEBEE;
      animation: shake 0.5s;
    }

    @keyframes successPulse {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }
    }

    /* Buttons vui nh·ªôn */
    .btn-fun {
      font-size: 1.2em;
      padding: 12px 30px;
      border: none;
      border-radius: 20px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 12px rgba(0, 0, 0, 0.2);
      margin: 5px;
      animation: fadeIn 1s ease-out;
      position: relative;
      z-index: 10;
    }

    .btn-fun:hover {
      transform: translateY(-5px) scale(1.05);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      filter: brightness(1.1);
    }

    .btn-fun:active {
      transform: translateY(-2px) scale(0.98);
      filter: brightness(0.9);
    }

    .btn-fun:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    .btn-next {
      background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
      color: white;
    }

    .btn-replay {
      background: linear-gradient(135deg, #2196F3 0%, #64B5F6 100%);
      color: white;
    }

    .btn-remember {
      background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
      color: white;
    }

    .btn-forgot {
      background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
      color: white;
    }

    .btn-home {
      background: linear-gradient(135deg, #9E9E9E 0%, #BDBDBD 100%);
      color: white;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: auto;
      padding-top: 15px;
      flex-wrap: wrap;
      justify-content: center;
      position: relative;
      z-index: 10;
      flex-shrink: 0;
      width: 100%;
    }

    /* Completion screen */
    .completion-screen {
      text-align: center;
      animation: zoomIn 0.8s ease-out;
    }

    .completion-screen h2 {
      font-size: 3em;
      color: #4CAF50;
      margin-bottom: 20px;
      animation: bounce 1s ease-out;
    }

    .completion-stats {
      font-size: 1.5em;
      color: #666;
      margin: 20px 0;
    }

    .completion-stars {
      font-size: 5em;
      margin: 30px 0;
      animation: starPop 0.8s ease-out;
    }

    /* Animations */
    @keyframes bounceIn {
      0% {
        transform: scale(0.3);
        opacity: 0;
      }

      50% {
        transform: scale(1.05);
      }

      70% {
        transform: scale(0.9);
      }

      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    @keyframes slideDown {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes zoomIn {
      from {
        transform: scale(0.8);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes bounce {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-20px);
      }
    }

    @keyframes pulse {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }
    }

    @keyframes rotate {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    @keyframes starPop {
      0% {
        transform: scale(0) rotate(0deg);
      }

      50% {
        transform: scale(1.2) rotate(180deg);
      }

      100% {
        transform: scale(1) rotate(360deg);
      }
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0);
      }

      25% {
        transform: translateX(-10px);
      }

      75% {
        transform: translateX(10px);
      }
    }

    @keyframes hintBlink {

      0%,
      100% {
        opacity: 0.4;
        transform: scale(1);
      }

      25%,
      75% {
        opacity: 1;
        transform: scale(1.2);
      }

      50% {
        opacity: 0.6;
        transform: scale(0.9);
      }
    }

    /* Confetti */
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background: #f0f;
      position: absolute;
      animation: confetti-fall 3s linear infinite;
    }

    @keyframes confetti-fall {
      to {
        transform: translateY(100vh) rotate(360deg);
      }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container-main {
        padding: 5px;
      }

      .fun-header {
        padding: 8px 15px;
        margin-bottom: 5px;
      }

      .fun-header h1 {
        font-size: 1.3em;
      }

      .fun-header .lesson-title {
        font-size: 0.9em;
      }

      .progress-container {
        padding: 8px 10px;
        margin-bottom: 5px;
      }

      .progress-text {
        font-size: 0.9em;
      }

      .progress-bar-custom {
        height: 25px;
      }

      .learning-card {
        padding: 15px;
        gap: 10px;
      }

      .step-badge {
        font-size: 0.8em;
        padding: 5px 12px;
      }

      .step-title {
        font-size: 1.3em;
      }

      .step-instruction {
        font-size: 1em;
      }

      .image-container {
        height: 140px;
        max-width: 280px;
      }

      .text-display {
        font-size: 1.8em;
      }

      .text-vietnamese {
        font-size: 1.4em;
      }

      .btn-fun {
        font-size: 0.95em;
        padding: 10px 18px;
      }

      .word-display {
        font-size: 2em;
        letter-spacing: 5px;
        margin: 8px 0;
      }

      .letter-blank {
        width: 40px;
        height: 50px;
        line-height: 50px;
      }

      .letter-choices {
        gap: 6px;
        margin-top: 8px;
        max-width: 100%;
        padding: 0 5px;
      }

      .letter-choice {
        width: 48px;
        height: 48px;
        font-size: 1.4em;
      }

      .button-group {
        padding-top: 10px;
      }

      .typing-input {
        font-size: 1.6em;
        padding: 12px 15px;
      }

      #hint-word {
        font-size: 2em !important;
        letter-spacing: 3px !important;
      }
    }

    @media (max-width: 480px) {
      .letter-choices {
        gap: 5px;
        margin-top: 8px;
      }

      .letter-choice {
        width: 45px;
        height: 45px;
        font-size: 1.3em;
      }

      .word-display {
        font-size: 1.8em;
        letter-spacing: 3px;
      }

      #hint-word {
        font-size: 1.8em !important;
      }

      .typing-input {
        font-size: 1.4em;
        padding: 10px 12px;
      }
    }

    @media (max-width: 380px) {
      .letter-choices {
        gap: 4px;
      }

      .letter-choice {
        width: 42px;
        height: 42px;
        font-size: 1.2em;
      }

      #hint-word {
        font-size: 1.5em !important;
        letter-spacing: 2px !important;
      }
    }
  </style>
</head>

<body>
  <div class="container-main">
    <!-- Header -->
    <div class="fun-header">
      <h1>
        <span>üéâ</span>
        <span>H·ªçc T·ª´ M·ªõi</span>
        <span>üìö</span>
      </h1>
      <div class="lesson-title" id="lesson-title">Loading...</div>
    </div>

    <!-- Progress -->
    <div class="progress-container">
      <div class="progress-text" id="progress-text">ƒêang t·∫£i...</div>
      <div class="progress-bar-custom">
        <div class="progress-bar-fill" id="progress-bar" style="width: 0%">0%</div>
      </div>
    </div>

    <!-- Learning Card -->
    <div class="learning-card" id="learning-card">
      <div class="step-badge" id="step-badge">B∆∞·ªõc 1/2</div>
      <h2 class="step-title" id="step-title">ƒêang t·∫£i...</h2>
      <p class="step-instruction" id="step-instruction"></p>

      <div class="image-container" id="image-container">
        <div class="image-placeholder">üì∑</div>
      </div>

      <div id="text-container"></div>

      <div class="button-group" id="button-group">
        <button class="btn-fun btn-replay" onclick="replayAudio()">üîä Nghe l·∫°i</button>
        <button class="btn-fun btn-next" onclick="nextStep()">‚û°Ô∏è Ti·∫øp theo</button>
      </div>
    </div>
  </div>

  <script src="../js/lesson-loader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    'use strict';

    // ============================================
    // üåç GLOBAL STATE
    // ============================================
    let CONFIG = null;
    let LESSON_DATA = null;
    let currentLessonId = null;
    let learningItems = []; // All words and sentences to learn
    let currentItemIndex = 0;
    let currentStep = 0; // 0: SHOW, 1: RECALL, 2: TEST
    let weakWords = []; // Track words the child struggles with
    let miniQuizDue = false; // Track if mini quiz is needed
    let itemsSinceQuiz = 0; // Count items since last quiz
    const MINI_QUIZ_INTERVAL = 5; // Mini quiz every 5 items

    const STEPS = [
      { name: 'learn', title: 'üìñ H·ªåC & LUY·ªÜN', instruction: 'Nh√¨n k·ªπ v√† nghe t·ª´ n√†y nh√©!' },
      { name: 'test', title: '‚úçÔ∏è KI·ªÇM TRA', instruction: 'H√£y ƒëi·ªÅn ch·ªØ c√°i c√≤n thi·∫øu!' },
      { name: 'typing', title: '‚å®Ô∏è G√ï L·∫†I', instruction: 'H√£y g√µ l·∫°i t·ª´ n√†y b·∫±ng b√†n ph√≠m!' }
    ];

    // ============================================
    // üé§ TTS MANAGER
    // ============================================
    function playSpeech(text, lang = 'en-US', callback = null) {
      if (!text) return;

      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = lang;
      utterance.rate = 0.85;
      utterance.pitch = 1.1;

      const voices = speechSynthesis.getVoices();
      const voice = voices.find(v => v.lang.startsWith(lang.split('-')[0]));
      if (voice) utterance.voice = voice;

      if (callback) {
        utterance.onend = callback;
      }

      speechSynthesis.cancel();
      speechSynthesis.speak(utterance);
    }

    // ============================================
    // üíæ DATA LOADER
    // ============================================
    async function loadData() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        currentLessonId = parseInt(urlParams.get('lesson') || '1');

        // Load Config
        const configRes = await fetch('../config.json');
        CONFIG = await configRes.json();

        // Init Firebase with Config User ID
        await initFirebase(CONFIG.user_id);

        // Load Lesson using LessonLoader
        LESSON_DATA = await LessonLoader.loadLesson(currentLessonId);

        if (!LESSON_DATA) {
          alert('Kh√¥ng t√¨m th·∫•y b√†i h·ªçc!');
          window.location.href = '../index.html';
          return;
        }

        document.getElementById('lesson-title').textContent = LESSON_DATA.title;

        // Prepare learning items (interleave words and sentences)
        prepareLearningItems();

        // Start learning
        startLearning();
      } catch (error) {
        console.error('L·ªói t·∫£i d·ªØ li·ªáu:', error);
        alert('C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu: ' + error.message);
      }
    }

    function prepareLearningItems() {
      learningItems = [];

      // Get config for max sentences
      const includeSentences = CONFIG?.new_word_learning?.include_sentences ?? true;
      const maxSentencesPerWord = CONFIG?.new_word_learning?.max_sentences_per_word ?? 10;

      // Interleave: Word ‚Üí Sentence example ‚Üí Word ‚Üí Sentence example
      LESSON_DATA.words.forEach((word, index) => {
        // Add word
        learningItems.push({
          type: 'word',
          word: word.word,
          meaning: word.meaning,
          images: word.images || [],
          sentences: word.sentences || []
        });

        // Add sentence examples right after (if enabled and available)
        if (includeSentences && word.sentences && word.sentences.length > 0) {
          const maxSentences = Math.min(maxSentencesPerWord, word.sentences.length);
          word.sentences.slice(0, maxSentences).forEach(sentence => {
            learningItems.push({
              type: 'sentence',
              en: sentence.en,
              vi: sentence.vi,
              images: sentence.images || [],
              fromWord: word.word
            });
          });
        }
      });

      console.log(`üìö T·ªïng s·ªë items c·∫ßn h·ªçc: ${learningItems.length}`);
      console.log(`‚öôÔ∏è Config: include_sentences=${includeSentences}, max_sentences_per_word=${maxSentencesPerWord}`);
    }

    // ============================================
    // üéÆ LEARNING CONTROLLER
    // ============================================
    function startLearning() {
      currentItemIndex = 0;
      currentStep = 0;
      weakWords = [];
      itemsSinceQuiz = 0;
      updateProgress();
      showCurrentStep();
    }

    function updateProgress() {
      const totalSteps = learningItems.length * 3; // 3 steps per item (learn, test, typing)
      const currentStepNumber = currentItemIndex * 3 + currentStep;
      const percentage = Math.round((currentStepNumber / totalSteps) * 100);

      document.getElementById('progress-text').textContent =
        `T·ª´ ${currentItemIndex + 1}/${learningItems.length} - B∆∞·ªõc ${currentStep + 1}/3`;

      const progressBar = document.getElementById('progress-bar');
      progressBar.style.width = percentage + '%';
      progressBar.textContent = percentage + '%';
    }

    function showCurrentStep() {
      const item = learningItems[currentItemIndex];
      const stepConfig = STEPS[currentStep];

      // Ensure base layout exists (Mini Quiz/Completion may have replaced it)
      const card = document.getElementById('learning-card');
      const needRebuild = !document.getElementById('step-badge')
        || !document.getElementById('step-title')
        || !document.getElementById('step-instruction')
        || !document.getElementById('image-container')
        || !document.getElementById('text-container')
        || !document.getElementById('button-group');
      if (card && needRebuild) {
        card.innerHTML = `
        <div class="step-badge" id="step-badge">B∆∞·ªõc ${currentStep + 1}/3</div>
        <h2 class="step-title" id="step-title"></h2>
        <p class="step-instruction" id="step-instruction"></p>
        <div class="image-container" id="image-container">
          <div class="image-placeholder">üì∑</div>
        </div>
        <div id="text-container"></div>
        <div class="button-group" id="button-group"></div>
      `;
      }

      // Update step badge and title
      document.getElementById('step-badge').textContent = `B∆∞·ªõc ${currentStep + 1}/3`;
      document.getElementById('step-title').textContent = stepConfig.title;
      document.getElementById('step-instruction').textContent = stepConfig.instruction;

      // Reset card animation
      card.style.animation = 'none';
      setTimeout(() => card.style.animation = '', 10);

      // Reset UI state (ƒë·∫£m b·∫£o m·ªçi th·ª© hi·ªÉn th·ªã ƒë√∫ng)
      resetUIState();

      // Show content based on step
      renderStepContent(item, stepConfig.name);
    }

    function resetUIState() {
      // ƒê·∫£m b·∫£o buttonGroup hi·ªÉn th·ªã (c√≥ th·ªÉ ƒë√£ b·ªã ·∫©n)
      const buttonGroup = document.getElementById('button-group');
      if (buttonGroup) {
        buttonGroup.style.display = 'flex';
        buttonGroup.style.visibility = 'visible';
      }
    }

    function renderStepContent(item, stepName) {
      const imageContainer = document.getElementById('image-container');
      const textContainer = document.getElementById('text-container');
      const buttonGroup = document.getElementById('button-group');

      // Show image (for words only)
      if (item.type === 'word') {
        const images = item.images || [];
        if (images.length > 0 && images[0]) {
          imageContainer.innerHTML = `<img src="../${images[0]}" alt="Image" onerror="this.style.display='none'">`;
          imageContainer.style.display = 'flex';
        } else {
          imageContainer.innerHTML = `<div class="image-placeholder">üì∑</div>`;
          imageContainer.style.display = 'flex';
        }
      } else {
        // Hide image for sentences
        imageContainer.style.display = 'none';
      }

      if (stepName === 'learn') {
        // Step 1: LEARN - Display with letter animation
        renderLearnStep(item, textContainer, buttonGroup);
      }
      else if (stepName === 'test') {
        // Step 2: TEST - Fill in missing letter (only for words)
        if (item.type === 'word') {
          renderTestStep(item, textContainer, buttonGroup);
        } else {
          // Skip test for sentences
          nextStep();
        }
      }
      else if (stepName === 'typing') {
        // Step 3: TYPING - Type the whole word (only for words)
        if (item.type === 'word') {
          renderTypingStep(item, textContainer, buttonGroup);
        } else {
          // Skip typing for sentences
          nextStep();
        }
      }
    }

    // ===== STEP 1: LEARN (Animation + Repeat) =====
    function renderLearnStep(item, textContainer, buttonGroup) {
      const text = item.type === 'word' ? item.word : item.en;
      const meaning = item.type === 'word' ? item.meaning : item.vi;

      let animatedHtml = '';
      let hintText = '';

      if (item.type === 'word') {
        // WORD: Animation t·ª´ng ch·ªØ c√°i (ch·∫≠m r√£i ƒë·ªÉ con nh√¨n k·ªπ)
        animatedHtml = text.split('').map((char, i) =>
          `<span class="letter-animate" style="animation-delay: ${i * 0.8}s; display: inline-block; opacity: 0;">${char}</span>`
        ).join('');
        hintText = 'üëÄ Nh√¨n k·ªπ t·ª´ng ch·ªØ c√°i nh√©!';
      } else {
        // SENTENCE: Animation t·ª´ng t·ª´ (ch·∫≠m r√£i)
        const words = text.split(' ');
        animatedHtml = words.map((word, i) =>
          `<span class="word-animate" style="animation-delay: ${i * 1.0}s; display: inline-block; opacity: 0; margin: 0 8px;">${word}</span>`
        ).join('');
        hintText = 'üëÄ Nh√¨n k·ªπ t·ª´ng t·ª´ nh√©!';
      }


      // Get config for learn step (mapping 'learn' to 'listen_understand')
      const stepConfig = CONFIG?.new_word_learning?.steps?.listen_understand || {
        show_text_en: true,
        show_text_vi: true
      };

      const showEn = stepConfig.show_text_en !== false; // Default true if missing
      const showVi = stepConfig.show_text_vi !== false;

      textContainer.innerHTML = `
      <div class="text-display text-vietnamese" style="font-size: 1.4em; margin-bottom: 15px; visibility: ${showVi ? 'visible' : 'hidden'}">
        ${meaning}
      </div>
      <div class="text-display text-english" id="animated-word" style="font-size: ${item.type === 'word' ? '2.5em' : '1.8em'}; letter-spacing: ${item.type === 'word' ? '3px' : '0px'}; min-height: 80px; line-height: 1.4; visibility: ${showEn ? 'visible' : 'hidden'}">
        ${animatedHtml}
      </div>
      <div style="margin-top: 15px; font-size: 1em; color: #666;">
        ${hintText}
      </div>
    `;

      // Add CSS animation - t·ª´ ph·∫£i sang tr√°i (ch·∫≠m r√£i, m∆∞·ª£t m√†)
      const style = document.createElement('style');
      style.textContent = `
      .letter-animate, .word-animate {
        animation: slideInFromRight 1s ease-out forwards;
      }
      @keyframes slideInFromRight {
        from {
          opacity: 0;
          transform: translateX(60px) scale(0.7);
        }
        to {
          opacity: 1;
          transform: translateX(0) scale(1);
        }
      }
    `;
      if (!document.getElementById('animation-styles')) {
        style.id = 'animation-styles';
        document.head.appendChild(style);
      }

      // Buttons
      buttonGroup.style.display = 'flex';
      buttonGroup.innerHTML = `
      <button class="btn-fun btn-replay" onclick="replayLearning()">üîä Xem l·∫°i</button>
      <button class="btn-fun btn-next" onclick="nextStep()">‚úÖ ƒê√£ nh·ªõ, ti·∫øp!</button>
    `;

      // Auto-play TTS - ƒë·ª£i animation ho√†n t·∫•t (t√≠nh to√°n delay)
      const totalDelay = item.type === 'word'
        ? text.length * 800 + 1000  // 800ms/ch·ªØ + 1000ms animation
        : text.split(' ').length * 1000 + 1000;  // 1000ms/t·ª´ + 1000ms animation
      setTimeout(() => playSpeech(text, 'en-US'), totalDelay);
    }

    window.replayLearning = function () {
      const item = learningItems[currentItemIndex];
      const text = item.type === 'word' ? item.word : item.en;
      const meaning = item.type === 'word' ? item.meaning : item.vi;
      const textContainer = document.getElementById('text-container');

      if (!textContainer) return;

      // Render l·∫°i to√†n b·ªô ƒë·ªÉ animation ch·∫°y t·ª´ ƒë·∫ßu
      let animatedHtml = '';
      let hintText = '';

      if (item.type === 'word') {
        // WORD: Animation t·ª´ng ch·ªØ c√°i
        animatedHtml = text.split('').map((char, i) =>
          `<span class="letter-animate" style="animation-delay: ${i * 0.8}s; display: inline-block; opacity: 0;">${char}</span>`
        ).join('');
        hintText = 'üëÄ Nh√¨n k·ªπ t·ª´ng ch·ªØ c√°i nh√©!';
      } else {
        // SENTENCE: Animation t·ª´ng t·ª´
        const words = text.split(' ');
        animatedHtml = words.map((word, i) =>
          `<span class="word-animate" style="animation-delay: ${i * 1.0}s; display: inline-block; opacity: 0; margin: 0 8px;">${word}</span>`
        ).join('');
        hintText = 'üëÄ Nh√¨n k·ªπ t·ª´ng t·ª´ nh√©!';
      }

      textContainer.innerHTML = `
      <div class="text-display text-vietnamese" style="font-size: 1.4em; margin-bottom: 15px;">
        ${meaning}
      </div>
      <div class="text-display text-english" id="animated-word" style="font-size: ${item.type === 'word' ? '2.5em' : '1.8em'}; letter-spacing: ${item.type === 'word' ? '3px' : '0px'}; min-height: 80px; line-height: 1.4;">
        ${animatedHtml}
      </div>
      <div style="margin-top: 15px; font-size: 1em; color: #666;">
        ${hintText}
      </div>
    `;

      // Replay audio sau khi animation ho√†n t·∫•t
      const totalDelay = item.type === 'word'
        ? text.length * 800 + 1000
        : text.split(' ').length * 1000 + 1000;
      setTimeout(() => playSpeech(text, 'en-US'), totalDelay);
    };

    // ===== STEP 3: TEST (Fill in missing letter) =====
    let hintTimeout = null; // Track hint timeout

    function renderTestStep(item, textContainer, buttonGroup) {
      const word = item.word;
      const meaning = item.meaning;

      // Clear any existing hint timeout
      if (hintTimeout) {
        clearTimeout(hintTimeout);
        hintTimeout = null;
      }

      // Hi·ªán l·∫°i image container (c√≥ th·ªÉ ƒë√£ b·ªã ·∫©n ·ªü b∆∞·ªõc RECALL)
      const imageContainer = document.getElementById('image-container');
      if (imageContainer && item.type === 'word') {
        const images = item.images || [];
        if (images.length > 0 && images[0]) {
          imageContainer.innerHTML = `<img src="../${images[0]}" alt="Image" onerror="this.style.display='none'">`;
          imageContainer.style.display = 'flex';
        } else {
          imageContainer.innerHTML = `<div class="image-placeholder">üì∑</div>`;
          imageContainer.style.display = 'flex';
        }
      }

      // Choose 1 random position for missing letter
      const missingIndex = Math.floor(Math.random() * word.length);
      const isFirstLetter = missingIndex === 0;

      const correctLetter = word[missingIndex].toLowerCase();

      // Generate wrong letters
      const wrongLetters = 'abcdefghijklmnopqrstuvwxyz'.split('')
        .filter(c => c !== correctLetter)
        .sort(() => Math.random() - 0.5)
        .slice(0, 5);

      const allLetters = [correctLetter, ...wrongLetters].sort(() => Math.random() - 0.5);

      // Build word display
      const wordHtml = word.split('').map((c, i) => {
        if (i === missingIndex) {
          return `<span class="letter-blank" id="letter-blank" data-answer="${correctLetter}"></span>`;
        }
        return `<span class="letter-fixed">${c}</span>`;
      }).join('');

      textContainer.innerHTML = `
      <div style="margin-bottom: 15px; font-size: 1.3em; color: #666;">
        <b>${meaning}</b>
      </div>
      <div class="word-display">${wordHtml}</div>
      <div class="letter-choices">
        ${allLetters.map(letter =>
        `<button class="letter-choice" onclick="selectLetter('${letter}')">${isFirstLetter ? letter.toUpperCase() : letter}</button>`
      ).join('')}
      </div>
    `;

      // ƒê·∫£m b·∫£o buttonGroup hi·ªÉn th·ªã
      buttonGroup.style.display = 'flex';
      buttonGroup.innerHTML = `
      <button class="btn-fun btn-replay" onclick="replayAudio()">üîä Nghe l·∫°i</button>
      <button class="btn-fun btn-hint" id="btn-hint" onclick="showHint()" style="opacity: 0; pointer-events: none; background: linear-gradient(135deg, #FFA726 0%, #FB8C00 100%); transition: opacity 0.5s ease;">üí° G·ª£i √Ω</button>
    `;

      // Show hint button after 3 seconds (reduced from 5s)
      hintTimeout = setTimeout(() => {
        const hintBtn = document.getElementById('btn-hint');
        if (hintBtn) {
          hintBtn.style.opacity = '1';
          hintBtn.style.pointerEvents = 'auto';
          playSpeech('N·∫øu con kh√¥ng nh·ªõ, nh·∫•n n√∫t g·ª£i √Ω nh√©!', 'vi-VN');
        }
      }, 3000);
    }

    window.showHint = function () {
      const blank = document.getElementById('letter-blank');
      const correctAnswer = blank.dataset.answer;

      if (!blank || !correctAnswer) return;

      // Clear hint timeout
      if (hintTimeout) {
        clearTimeout(hintTimeout);
        hintTimeout = null;
      }

      // Show hint: display correct letter with light color and blink
      blank.textContent = correctAnswer.toUpperCase();
      blank.style.color = 'rgba(76, 175, 80, 0.4)';
      blank.style.animation = 'hintBlink 2s ease-in-out';

      playSpeech('Ch·ªØ c√°i l√†: ' + correctAnswer.toUpperCase(), 'vi-VN');

      // Remove hint after 2 seconds
      setTimeout(() => {
        blank.textContent = '';
        blank.style.color = '';
        blank.style.animation = '';
      }, 2000);
    };

    window.selectLetter = function (letter) {
      const blank = document.getElementById('letter-blank');
      const correctAnswer = blank.dataset.answer;

      // Clear hint timeout when user starts answering
      if (hintTimeout) {
        clearTimeout(hintTimeout);
        hintTimeout = null;
      }

      blank.textContent = letter;
      blank.classList.add('filled');
      blank.style.color = ''; // Reset color
      blank.style.animation = ''; // Reset animation

      // Mark used letter
      document.querySelectorAll('.letter-choice').forEach(btn => {
        if (btn.textContent.toLowerCase() === letter) {
          btn.classList.add('used');
        }
      });

      if (letter === correctAnswer) {
        // Correct!
        playSpeech('Ch√≠nh x√°c', 'vi-VN');

        setTimeout(() => {
          nextStep();
        }, 1500);
      } else {
        // Wrong - ph·∫£i s·ª≠a l·∫°i cho ƒë√∫ng
        blank.classList.add('wrong');
        playSpeech('Sai r·ªìi, h√£y s·ª≠a l·∫°i cho ƒë√∫ng nh√©!', 'vi-VN');

        // Add to weak words
        const item = learningItems[currentItemIndex];
        if (!weakWords.includes(item)) {
          weakWords.push(item);
        }

        // Kh√¥ng t·ª± ƒë·ªông chuy·ªÉn ti·∫øp, ph·∫£i ƒë·ª£i ng∆∞·ªùi d√πng s·ª≠a l·∫°i
        setTimeout(() => {
          blank.classList.remove('wrong', 'filled');
          blank.textContent = '';
          // Re-enable letters ƒë·ªÉ cho ph√©p ch·ªçn l·∫°i
          document.querySelectorAll('.letter-choice').forEach(btn => {
            btn.classList.remove('used');
          });
        }, 1500);
      }
    };

    // ===== STEP 3: TYPING (Type the whole word) =====
    let typingHintTimeout = null;

    function renderTypingStep(item, textContainer, buttonGroup) {
      const word = item.word;
      const meaning = item.meaning;

      // Clear any existing hint timeout
      if (typingHintTimeout) {
        clearTimeout(typingHintTimeout);
        typingHintTimeout = null;
      }

      // Hi·ªán l·∫°i image container
      const imageContainer = document.getElementById('image-container');
      if (imageContainer && item.type === 'word') {
        const images = item.images || [];
        if (images.length > 0 && images[0]) {
          imageContainer.innerHTML = `<img src="../${images[0]}" alt="Image" onerror="this.style.display='none'">`;
          imageContainer.style.display = 'flex';
        } else {
          imageContainer.innerHTML = `<div class="image-placeholder">üì∑</div>`;
          imageContainer.style.display = 'flex';
        }
      }

      textContainer.innerHTML = `
      <div style="margin-bottom: 15px; font-size: 1.3em; color: #666;">
        <b>${meaning}</b>
      </div>
      <div id="hint-display" style="min-height: 60px; margin: 10px 0; display: flex; align-items: center; justify-content: center;">
        <div id="hint-word" style="font-size: 2.5em; font-weight: bold; color: #4CAF50; letter-spacing: 5px; opacity: 0; transition: opacity 0.3s ease;"></div>
      </div>
      <div style="margin: 20px 0;">
        <input 
          type="text" 
          id="typing-input" 
          class="typing-input" 
          placeholder="G√µ t·ª´ ·ªü ƒë√¢y..."
          autocomplete="off"
          autocapitalize="off"
          spellcheck="false"
          data-answer="${word.toLowerCase()}"
        />
      </div>
      <div style="font-size: 0.9em; color: #999; margin-top: 10px;">
        üí° G√µ t·ª´ ti·∫øng Anh t∆∞∆°ng ·ª©ng
      </div>
    `;

      // ƒê·∫£m b·∫£o buttonGroup hi·ªÉn th·ªã
      buttonGroup.style.display = 'flex';
      buttonGroup.innerHTML = `
      <button class="btn-fun btn-replay" onclick="replayAudio()">üîä Nghe l·∫°i</button>
      <button class="btn-fun btn-next" onclick="checkTypingAnswer()">‚úÖ Ki·ªÉm tra</button>
      <button class="btn-fun btn-hint" id="typing-hint" onclick="showTypingHint()" style="opacity: 0; pointer-events: none; background: linear-gradient(135deg, #FFA726 0%, #FB8C00 100%); transition: opacity 0.5s ease;">üí° G·ª£i √Ω</button>
    `;

      // Focus v√†o input
      setTimeout(() => {
        const input = document.getElementById('typing-input');
        if (input) input.focus();
      }, 100);

      // Add event listener
      const input = document.getElementById('typing-input');
      if (input) {
        input.addEventListener('input', handleTypingInput);
        input.addEventListener('keydown', handleTypingKeydown);
      }

      // Show hint button after 3 seconds (reduced from 5s)
      typingHintTimeout = setTimeout(() => {
        const hintBtn = document.getElementById('typing-hint');
        if (hintBtn) {
          hintBtn.style.opacity = '1';
          hintBtn.style.pointerEvents = 'auto';
          playSpeech('N·∫øu con kh√¥ng nh·ªõ, nh·∫•n n√∫t g·ª£i √Ω nh√©!', 'vi-VN');
        }
      }, 3000);

      // Auto play word
      playSpeech(word, 'en-US');
    }

    function handleTypingInput(e) {
      const input = e.target;
      const userInput = input.value.toLowerCase().trim();
      const correctAnswer = input.dataset.answer;

      // Clear hint timeout when user starts typing
      if (typingHintTimeout) {
        clearTimeout(typingHintTimeout);
        typingHintTimeout = null;
      }

      // Remove any error state
      input.classList.remove('wrong');
    }

    function handleTypingKeydown(e) {
      if (e.key === 'Enter') {
        checkTypingAnswer();
      }
    }

    window.checkTypingAnswer = function () {
      const input = document.getElementById('typing-input');
      if (!input) return;

      const userInput = input.value.toLowerCase().trim();
      const correctAnswer = input.dataset.answer;

      if (userInput === correctAnswer) {
        // Correct!
        input.classList.add('correct');
        input.disabled = true;
        playSpeech('Ch√≠nh x√°c! Gi·ªèi l·∫Øm!', 'vi-VN');

        setTimeout(() => {
          nextStep();
        }, 1500);
      } else {
        // Wrong - ph·∫£i s·ª≠a l·∫°i cho ƒë√∫ng
        input.classList.add('wrong');
        playSpeech('Ch∆∞a ƒë√∫ng, h√£y s·ª≠a l·∫°i cho ƒë√∫ng nh√©!', 'vi-VN');

        // Add to weak words
        const item = learningItems[currentItemIndex];
        if (!weakWords.includes(item)) {
          weakWords.push(item);
        }

        // Kh√¥ng t·ª± ƒë·ªông chuy·ªÉn ti·∫øp, ph·∫£i ƒë·ª£i ng∆∞·ªùi d√πng s·ª≠a l·∫°i
        setTimeout(() => {
          input.classList.remove('wrong');
          input.value = '';
          input.focus();
        }, 1500);
      }
    };

    window.showTypingHint = function () {
      const input = document.getElementById('typing-input');
      const hintWord = document.getElementById('hint-word');
      if (!input || !hintWord) return;

      const correctAnswer = input.dataset.answer;

      // Clear timeout
      if (typingHintTimeout) {
        clearTimeout(typingHintTimeout);
        typingHintTimeout = null;
      }

      // Show answer above input (2 seconds)
      hintWord.textContent = correctAnswer.toUpperCase();
      hintWord.style.opacity = '1';
      hintWord.style.animation = 'hintBlink 2s ease-in-out';

      playSpeech('ƒê√°p √°n l√†: ' + correctAnswer, 'en-US');

      // Hide after 2 seconds
      setTimeout(() => {
        hintWord.style.opacity = '0';
        hintWord.style.animation = '';
        input.focus();
        playSpeech('B√¢y gi·ªù con g√µ l·∫°i nh√©!', 'vi-VN');
      }, 2000);
    };

    function nextStep() {
      // Clear all hint timeouts when moving to next step
      if (hintTimeout) {
        clearTimeout(hintTimeout);
        hintTimeout = null;
      }
      if (typingHintTimeout) {
        clearTimeout(typingHintTimeout);
        typingHintTimeout = null;
      }

      currentStep++;

      if (currentStep >= 3) {
        // Completed all 3 steps for this item
        const completedItem = learningItems[currentItemIndex];
        trackItemLearned(completedItem);

        // Move to next item
        currentStep = 0;
        currentItemIndex++;
        itemsSinceQuiz++;

        // Check if mini quiz is needed (only for words)
        if (itemsSinceQuiz >= MINI_QUIZ_INTERVAL && currentItemIndex < learningItems.length) {
          const recentWords = learningItems.slice(Math.max(0, currentItemIndex - MINI_QUIZ_INTERVAL), currentItemIndex)
            .filter(item => item.type === 'word');
          if (recentWords.length >= 3) {
            showMiniQuiz();
            return;
          }
        }

        if (currentItemIndex >= learningItems.length) {
          // Check if need to review weak words
          if (weakWords.length > 0) {
            showWeakWordsReview();
            return;
          }

          // Finished all items
          showCompletion();
          return;
        }
      }

      updateProgress();
      showCurrentStep();
    }

    function replayAudio() {
      const item = learningItems[currentItemIndex];
      const stepName = STEPS[currentStep].name;

      if (stepName === 'learn') {
        replayLearning();
      } else {
        // In test step, just replay word
        const text = item.type === 'word' ? item.word : item.en;
        playSpeech(text, 'en-US');
      }
    }

    // ============================================
    // üéØ MINI QUIZ (Every 5 items)
    // ============================================
    let miniQuizHintTimeout = null; // Track mini quiz hint timeout

    function showMiniQuiz() {
      const card = document.getElementById('learning-card');
      const recentItems = learningItems.slice(Math.max(0, currentItemIndex - MINI_QUIZ_INTERVAL), currentItemIndex)
        .filter(item => item.type === 'word'); // Only quiz words

      if (recentItems.length === 0) {
        itemsSinceQuiz = 0;
        showCurrentStep();
        return;
      }

      // Shuffle and pick 3 random items
      const quizItems = recentItems.sort(() => Math.random() - 0.5).slice(0, 3);
      let quizIndex = 0;

      function showQuizQuestion() {
        // Clear any existing hint timeout
        if (miniQuizHintTimeout) {
          clearTimeout(miniQuizHintTimeout);
          miniQuizHintTimeout = null;
        }

        if (quizIndex >= quizItems.length) {
          // Quiz completed
          playSpeech('Gi·ªèi l·∫Øm! Ti·∫øp t·ª•c h·ªçc nh√©!', 'vi-VN');
          itemsSinceQuiz = 0;
          setTimeout(() => {
            updateProgress();
            showCurrentStep();
          }, 2000);
          return;
        }

        const item = quizItems[quizIndex];
        const correctAnswer = item.word;

        // Generate 3 wrong answers
        const otherWords = LESSON_DATA.words
          .filter(w => w.word !== correctAnswer)
          .map(w => w.word);
        const wrongAnswers = otherWords
          .sort(() => Math.random() - 0.5)
          .slice(0, 3);

        const options = [correctAnswer, ...wrongAnswers].sort(() => Math.random() - 0.5);

        card.innerHTML = `
        <div class="step-badge">√în t·∫≠p nhanh ${quizIndex + 1}/${quizItems.length}</div>
        <h2 class="step-title">üéØ T·ª´ n√†y l√† g√¨?</h2>
        <div class="text-display text-vietnamese">${item.meaning}</div>
        <div class="button-group" style="flex-direction: column; max-width: 400px; width: 100%;">
          ${options.map(opt =>
          `<button class="btn-fun quiz-option-btn" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" 
              data-waiting-for-retry="false"
              onclick='checkMiniQuizAnswer(${JSON.stringify(opt)}, ${JSON.stringify(correctAnswer)})'>${opt}</button>`
        ).join('')}
          <button class="btn-fun btn-hint" id="mini-quiz-hint" onclick='showMiniQuizHint(${JSON.stringify(correctAnswer)})' 
            style="opacity: 0; pointer-events: none; background: linear-gradient(135deg, #FFA726 0%, #FB8C00 100%); transition: opacity 0.5s ease; width: 100%;">
            üí° G·ª£i √Ω
          </button>
        </div>
      `;

        playSpeech(item.meaning, 'vi-VN');

        // Show hint button after 5 seconds
        miniQuizHintTimeout = setTimeout(() => {
          const hintBtn = document.getElementById('mini-quiz-hint');
          if (hintBtn) {
            hintBtn.style.opacity = '1';
            hintBtn.style.pointerEvents = 'auto';
            playSpeech('N·∫øu con kh√¥ng nh·ªõ, nh·∫•n n√∫t g·ª£i √Ω nh√©!', 'vi-VN');
          }
        }, 5000);
      }

      window.showMiniQuizHint = function (correctAnswer) {
        // Clear timeout
        if (miniQuizHintTimeout) {
          clearTimeout(miniQuizHintTimeout);
          miniQuizHintTimeout = null;
        }

        // Highlight correct answer button
        const buttons = document.querySelectorAll('.quiz-option-btn');
        buttons.forEach(btn => {
          if (btn.textContent === correctAnswer) {
            btn.style.border = '4px solid #4CAF50';
            btn.style.boxShadow = '0 0 20px rgba(76, 175, 80, 0.8)';
            btn.style.animation = 'hintBlink 2s ease-in-out';
          }
        });

        playSpeech('ƒê√°p √°n l√†: ' + correctAnswer, 'vi-VN');

        // Remove hint after 2 seconds
        setTimeout(() => {
          buttons.forEach(btn => {
            btn.style.border = '';
            btn.style.boxShadow = '0 5px 12px rgba(0,0,0,0.2)';
            btn.style.animation = '';
          });
        }, 2000);
      };

      window.checkMiniQuizAnswer = function (selected, correct) {
        // Clear hint timeout
        if (miniQuizHintTimeout) {
          clearTimeout(miniQuizHintTimeout);
          miniQuizHintTimeout = null;
        }

        const buttons = document.querySelectorAll('.quiz-option-btn');

        // Ki·ªÉm tra xem c√≥ ƒëang trong tr·∫°ng th√°i ch·ªù s·ª≠a l·∫°i kh√¥ng
        const isWaitingForRetry = Array.from(buttons).some(btn => btn.dataset.waitingForRetry === 'true');

        if (isWaitingForRetry) {
          // ƒêang ch·ªù s·ª≠a l·∫°i - ch·ªâ cho ph√©p ch·ªçn ƒë√°p √°n ƒë√∫ng
          if (selected === correct) {
            // Ch·ªçn ƒë√∫ng - chuy·ªÉn ti·∫øp
            buttons.forEach(btn => {
              btn.disabled = true;
              btn.dataset.waitingForRetry = 'false';
            });
            playSpeech('Ch√≠nh x√°c', 'vi-VN');
            quizIndex++;
            setTimeout(showQuizQuestion, 2000);
          } else {
            // Ch·ªçn sai l·∫ßn n·ªØa - ch·ªâ b√°o sai
            playSpeech('V·∫´n ch∆∞a ƒë√∫ng, h√£y ch·ªçn ƒë√°p √°n ƒë√∫ng nh√©!', 'vi-VN');
          }
          return;
        }

        if (selected === correct) {
          // Correct - chuy·ªÉn ti·∫øp
          buttons.forEach(btn => {
            if (btn.textContent === correct) {
              btn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%)';
              btn.style.color = 'white';
            }
            btn.disabled = true;
            btn.dataset.waitingForRetry = 'false';
          });
          playSpeech('Ch√≠nh x√°c', 'vi-VN');

          // Chuy·ªÉn sang c√¢u ti·∫øp theo sau 2 gi√¢y
          quizIndex++;
          setTimeout(showQuizQuestion, 2000);
        } else {
          // Wrong - ph·∫£i s·ª≠a l·∫°i cho ƒë√∫ng
          buttons.forEach(btn => {
            if (btn.textContent === selected) {
              btn.style.background = 'linear-gradient(135deg, #f5576c 0%, #f093fb 100%)';
              btn.style.color = 'white';
              btn.classList.add('wrong-answer');
              btn.disabled = true; // Disable button ƒë√£ ch·ªçn sai
            }
            if (btn.textContent === correct) {
              btn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%)';
              btn.style.color = 'white';
              btn.style.border = '3px solid #4CAF50';
              btn.style.boxShadow = '0 0 15px rgba(76, 175, 80, 0.6)';
              // ƒê√°nh d·∫•u ƒë·ªÉ c√≥ th·ªÉ click v√†o button ƒë√∫ng
              btn.dataset.waitingForRetry = 'true';
            }
          });
          playSpeech('Sai r·ªìi, h√£y ch·ªçn ƒë√°p √°n ƒë√∫ng nh√©!', 'vi-VN');

          // Re-enable button ƒë√∫ng sau 2 gi√¢y ƒë·ªÉ cho ph√©p ch·ªçn l·∫°i, KH√îNG t·ª± ƒë·ªông chuy·ªÉn ti·∫øp
          setTimeout(() => {
            buttons.forEach(btn => {
              if (btn.dataset.waitingForRetry === 'true') {
                btn.disabled = false;
                // Cho ph√©p click v√†o button ƒë√∫ng ƒë·ªÉ chuy·ªÉn ti·∫øp
              }
            });
          }, 2000);
        }
      };

      showQuizQuestion();
    }

    // ============================================
    // üîÑ WEAK WORDS REVIEW
    // ============================================
    function showWeakWordsReview() {
      playSpeech('B√¢y gi·ªù c√¥ √¥n l·∫°i nh·ªØng t·ª´ con c√≤n ch∆∞a thu·ªôc nh√©!', 'vi-VN');

      setTimeout(() => {
        // Add weak words back to learning queue
        learningItems = [...learningItems, ...weakWords];
        weakWords = []; // Clear for next round

        // Continue learning
        updateProgress();
        showCurrentStep();
      }, 3000);
    }

    // ============================================
    // üéâ COMPLETION
    // ============================================
    function showCompletion() {
      createConfetti();

      const card = document.getElementById('learning-card');
      card.innerHTML = `
      <div class="completion-screen">
        <h2>üéâ XU·∫§T S·∫ÆC! üéâ</h2>
        <div class="completion-stars">‚≠ê‚≠ê‚≠ê</div>
        <div class="completion-stats">
          ‚úÖ ƒê√£ h·ªçc: ${learningItems.filter(i => i.type === 'word').length} t·ª´<br>
          ‚úÖ ƒê√£ h·ªçc: ${learningItems.filter(i => i.type === 'sentence').length} c√¢u<br>
          ‚è±Ô∏è B√†i h·ªçc: ${LESSON_DATA.title}
        </div>
        <div class="button-group">
          <button class="btn-fun btn-replay" onclick="restartLesson()">üîÑ H·ªçc l·∫°i</button>
          <button class="btn-fun btn-next" onclick="goToQuiz()">‚úçÔ∏è L√†m b√†i t·∫≠p</button>
          <button class="btn-fun btn-home" onclick="goHome()">üè† Trang ch·ªß</button>
        </div>
      </div>
    `;

      playSpeech('Ch√∫c m·ª´ng em ƒë√£ ho√†n th√†nh b√†i h·ªçc! Gi·ªèi l·∫Øm!', 'vi-VN');
    }

    function createConfetti() {
      const colors = ['#FF6B6B', '#4CAF50', '#2196F3', '#FFD93D', '#9C27B0'];
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.left = Math.random() * 100 + 'vw';
          confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
          confetti.style.animationDelay = Math.random() * 2 + 's';
          document.body.appendChild(confetti);
          setTimeout(() => confetti.remove(), 3000);
        }, i * 50);
      }
    }

    function restartLesson() {
      location.reload();
    }

    function goToQuiz() {
      window.location.href = `lambaitap.html?lesson=${currentLessonId}`;
    }

    function goHome() {
      window.location.href = '../index.html';
    }

    // ============================================
    // üöÄ INITIALIZE
    // ============================================
    window.addEventListener('load', async () => {
      // Load voices
      speechSynthesis.getVoices();
      speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();

      // Load data and start (Firebase init will happen inside after config load)
      loadData();
    });

    // ===== FIREBASE INTEGRATION =====
    async function initFirebase(configUserId) {
      try {
        if (typeof ProgressManager !== 'undefined') {
          await ProgressManager.init(configUserId);
          console.log('‚úÖ Firebase initialized for hocbaimoi.html');
        } else {
          console.warn('‚ö†Ô∏è ProgressManager not loaded');
        }
      } catch (error) {
        console.error('‚ùå Firebase init error:', error);
      }
    }

    // Track when user completes learning an item
    function trackItemLearned(item) {
      if (typeof ProgressManager === 'undefined' || !ProgressManager.userId) {
        console.log('üìù Progress tracking not available');
        return;
      }

      try {
        const question = {
          lessonId: currentLessonId,
          word: item.type === 'word' ? item.word : null,
          sentence: item.type === 'sentence' ? item.en : null,
          question: item.type === 'sentence' ? item.vi : null,
          correctAnswer: item.type === 'word' ? item.meaning : null
        };

        // Mark as "studied" (always correct for learning mode)
        ProgressManager.update(question, true);
        console.log('‚òÅÔ∏è Learned item synced to Firebase:', item.type === 'word' ? item.word : item.en);
      } catch (error) {
        console.error('‚ùå Error tracking progress:', error);
      }
    }
  </script>

  <!-- ===== Firebase CDN ===== -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <!-- ===== Firebase Config & Progress Manager ===== -->
  <script src="../js/firebase-config.js"></script>
  <script src="../js/quiz-progress.js"></script>
</body>

</html>